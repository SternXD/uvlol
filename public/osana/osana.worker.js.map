{"version":3,"file":"osana.worker.js","mappings":"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","sources":["webpack://osana/./src/lib/util/worker.ts"],"sourcesContent":["var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nimportScripts(`./osana.bundle.js?1`);\nimportScripts(`./osana.config.js?1`);\nself.OsanaServiceWorker = class OsanaServiceWorker {\n    constructor() {\n        this.config = self.__osana$config;\n        this.bundle = self.__osana$bundle;\n        this.bareClient = new this.bundle.BareClient(this.config.bare);\n    }\n    fetch(event) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const url = this.config.codec.decode(event.request.url.slice((location.origin + this.config.prefix).length)) + new URL(event.request.url).search;\n            if (!/^https?:\\/\\//.test(url)) {\n                return fetch(event.request.url);\n            }\n            const requestURL = new URL(url);\n            const requestHeaders = this.bundle.rewrite.headers.request(Object.fromEntries(event.request.headers.entries()), requestURL);\n            if (this.config.blacklist && this.config.blacklist.some(regex => regex.test(requestURL.host))) {\n                return new BlackListedResponse();\n            }\n            const bareRequestData = {\n                method: event.request.method,\n                headers: requestHeaders\n            };\n            if (![\"GET\", \"HEAD\"].includes(event.request.method))\n                bareRequestData.body = yield event.request.blob();\n            const response = yield this.bareClient.fetch(requestURL, bareRequestData);\n            let responseStatus = response.rawResponse.status;\n            const responseHeaders = this.bundle.rewrite.headers.response(response.rawHeaders, requestURL);\n            let type = responseHeaders[\"Content-Type\"];\n            let responseData = \"\";\n            /* If you want to add this back you can, I just wanted to use a switch statement for code readability */\n            // if (/text\\/html/.test(responseHeaders[\"Content-Type\"] as string)) {\n            //   responseData = \n            //     `<head>\n            //       <script src=\"${this.config.files.bundle}\"></script>\n            //       <script src=\"${this.config.files.config}\"></script>\n            //       <script src=\"${this.config.files.client}\"></script>\n            //       <link rel=\"icon\" href=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAA1JREFUGFdjYGBkZAAAAAoAAx9k7/gAAAAASUVORK5CYIIA\">\n            //       <link rel=\"icon\" href=\"${requestURL.origin}/favicon.ico\">\n            //       ${(responseStatus === 301 && responseHeaders[\"location\"]) ? `<meta http-equiv=\"refresh\" content=\"0; url=${this.bundle.rewrite.url(responseHeaders[\"location\"] as string)}\">` : \"\"}\n            //     </head>`;\n            //   responseData += this.bundle.rewrite.html(await response.text(), url);\n            // } else if (/text\\/css/.test(responseHeaders[\"Content-Type\"] as string) || event.request.destination === \"style\") {\n            //   responseData = this.bundle.rewrite.css(await response.text(), url);\n            // } else if (/application\\/javascript/.test(responseHeaders[\"Content-Type\"] as string) || event.request.destination === \"script\") {\n            //   responseData = this.bundle.rewrite.js(await response.text(), url);\n            // } else {\n            //   responseData = await response.arrayBuffer();\n            // }\n            switch (true) {\n                case /text\\/html/.test(type):\n                    let responseText = yield response.text();\n                    if (responseText.includes(\"<head>\")) {\n                        const head = `<head$1>\n            <script src=\"${this.config.files.bundle}\"></script>\n            <script src=\"${this.config.files.config}\"></script>\n            <script src=\"${this.config.files.client}\"></script>\n            <link rel=\"icon\" href=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAA1JREFUGFdjYGBkZAAAAAoAAx9k7/gAAAAASUVORK5CYIIA\">\n            <link rel=\"icon\" href=\"${requestURL.origin}/favicon.ico\">\n            ${(responseStatus === 301 && responseHeaders[\"location\"]) ? `<meta http-equiv=\"refresh\" content=\"0; url=${this.bundle.rewrite.url.rewriteURL(responseHeaders[\"location\"])}\">` : \"\"}\n          `;\n                        responseData = this.bundle.rewrite.html(yield responseText, url).replace(/<head(.*?)>/g, head);\n                    }\n                    else {\n                        responseData =\n                            `<head>\n            <script src=\"${this.config.files.bundle}\"></script>\n            <script src=\"${this.config.files.config}\"></script>\n            <script src=\"${this.config.files.client}\"></script>\n            <link rel=\"icon\" href=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAA1JREFUGFdjYGBkZAAAAAoAAx9k7/gAAAAASUVORK5CYIIA\">\n            <link rel=\"icon\" href=\"${requestURL.origin}/favicon.ico\">\n            ${(responseStatus === 301 && responseHeaders[\"location\"]) ? `<meta http-equiv=\"refresh\" content=\"0; url=${this.bundle.rewrite.url.rewriteURL(responseHeaders[\"location\"])}\">` : \"\"}\n          </head>`;\n                        responseData += this.bundle.rewrite.html(responseText, url);\n                    }\n                    // responseData = \n                    //   `<!DOCTYPE html>\n                    //     <head>\n                    //       <script src=\"${this.config.files.bundle}\"></script>\n                    //       <script src=\"${this.config.files.config}\"></script>\n                    //       <script src=\"${this.config.files.client}\"></script>\n                    //       <link rel=\"icon\" href=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAA1JREFUGFdjYGBkZAAAAAoAAx9k7/gAAAAASUVORK5CYIIA\">\n                    //       <link rel=\"icon\" href=\"${requestURL.origin}/favicon.ico\">\n                    //       ${(responseStatus === 301 && responseHeaders[\"location\"]) ? `<meta http-equiv=\"refresh\" content=\"0; url=${this.bundle.rewrite.url.rewriteURL(responseHeaders[\"location\"] as string)}\">` : \"\"}\n                    //     </head>`;\n                    break;\n                case (/text\\/css/.test(type) || event.request.destination === \"style\"):\n                    responseData = this.bundle.rewrite.css(yield response.text(), url);\n                    break;\n                case (/(text|application)\\/javascript/.test(type) || event.request.destination === \"script\"):\n                    responseData = this.bundle.rewrite.js(yield response.text(), url);\n                    break;\n                default:\n                    responseData = yield response.arrayBuffer();\n            }\n            return new Response(responseData, {\n                status: response.rawResponse.status,\n                statusText: response.rawResponse.statusText,\n                headers: responseHeaders\n            });\n        });\n    }\n};\nclass BlackListedResponse extends Response {\n    constructor() {\n        super(\"Forbidden\", {\n            status: 403,\n            statusText: \"Forbidden\",\n            headers: {\n                \"Content-Type\": \"text/plain\"\n            }\n        });\n    }\n}\nexport {};\n"],"names":["importScripts","self","OsanaServiceWorker","constructor","this","config","__osana$config","bundle","__osana$bundle","bareClient","BareClient","bare","fetch","event","thisArg","_arguments","generator","url","codec","decode","request","slice","location","origin","prefix","length","URL","search","test","requestURL","requestHeaders","rewrite","headers","Object","fromEntries","entries","blacklist","some","regex","host","BlackListedResponse","bareRequestData","method","includes","body","blob","response","responseStatus","rawResponse","status","responseHeaders","rawHeaders","type","responseData","responseText","text","head","files","client","rewriteURL","html","replace","destination","css","js","arrayBuffer","Response","statusText","P","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","super"],"sourceRoot":""}